"use strict";const i=require("../../common/vendor.js"),r=require("../../data/herbData.js"),u={},x={data(){return{columnCount:2,columnData:[[],[]],allMedicines:[],scrollViewHeight:600,scrollTop:0,itemHeight:360,visibleCount:0,startIndex:0,offsetTop:0,isLoading:!1,loadThreshold:5,endIndex:0,loadQueue:0,maxLoadQueue:5,hasMore:!0,currentPage:1,pageSize:40,heightTimers:{},showContentSkeleton:!0,loadingProgress:0}},mounted(){this.loadMedicines(),this.initScrollView(),i.index.__f__("log","at components/my-content-bar/my-content-bar.vue:100","药材总数:",r.nameData.length)},computed:{totalHeight(){return this.allMedicines.length*this.itemHeight},dynamicPaddingTop(){return Math.max(0,this.headerHeight-this.scrollOffset)}},methods:{goToContent(t){i.index.navigateTo({url:`/pages/content/content?keyword=${t}&source=index`})},initScrollView(){this.$nextTick(()=>{i.index.createSelectorQuery().in(this).select(".virtual-scroll-container").boundingClientRect(s=>{s&&(this.scrollViewHeight=s.height,this.visibleCount=Math.max(1,Math.ceil(this.scrollViewHeight/this.itemHeight)+5))}).exec()})},calculateVisibleRange(t){if(Date.now()-this.lastScrollTime<100)return;const s=this.columnCount;Math.ceil(this.scrollViewHeight/this.itemHeight)*this.columnCount,this.startIndex=Math.max(0,Math.floor(t/this.itemHeight)*s-10),this.endIndex=this.allMedicines.length,typeof this.lastStartIndex>"u"&&(this.lastStartIndex=this.startIndex),Math.abs(this.startIndex-this.lastStartIndex)>30&&(this.updateVisibleItems(),this.lastStartIndex=this.startIndex),this.shouldLoadMore()&&this.loadMedicines(),this.offsetTop=this.startIndex*this.itemHeight},updateVisibleItems(){this.columnData.forEach(e=>e.length=0);const t=Math.min(this.endIndex,this.allMedicines.length),s=this.allMedicines.slice(this.startIndex,t);for(let e=0;e<this.columnCount;e++)Array.isArray(this.columnData[e])||(this.columnData[e]=[]),this.columnData[e].length=0;s.forEach((e,a)=>{const o=a%this.columnCount;this.columnData[o].push({...e,id:`item-${this.startIndex+a}`})})},updateItemHeight(t,s){clearTimeout(this.heightTimers[s]),this.heightTimers[s]=setTimeout(()=>{i.index.createSelectorQuery().in(this).select(`#box-${s}`).boundingClientRect(e=>{e&&e.height>this.itemHeight&&(this.itemHeight=e.height)}).exec()},200)},shouldLoadMore(){const t=this.allMedicines.length-this.endIndex;return!this.isLoading&&this.hasMore&&t>0},async loadMedicines(){if(this.showContentSkeleton=!0,this.loadingProgress=0,!(this.isLoading||!this.hasMore)){this.loadQueue++,this.isLoading=!0;try{const t=(this.currentPage-1)*this.pageSize;if(t>=r.nameData.length){this.hasMore=!1;return}const s=Math.ceil(r.nameData.length/this.pageSize);let e=0;for(let a=1;a<=s;a++){const o=Math.min(t+this.pageSize,r.nameData.length),h=r.nameData.slice(t,o),l=await Promise.all(h.map(async c=>{const n=await this.cachedRequest(c);return{id:`${this.currentPage}-${c}`,name:c,image:this.getMedicineImage(c),flavor:(n==null?void 0:n.flavor)||(n==null?void 0:n.property)||"暂无数据",effect:(n==null?void 0:n.effect)||(n==null?void 0:n.function)||"暂无数据"}}));this.allMedicines=[...this.allMedicines,...l],this.currentPage++,this.$nextTick(()=>{this.columnData=Array.from({length:this.columnCount},()=>[]),this.calculateVisibleRange(0),this.updateVisibleItems()});const d=Math.ceil(r.nameData.length/this.pageSize);this.allMedicines.length<r.nameData.length?this.$nextTick(()=>{this.loadMedicines()}):(this.hasMore=!1,i.index.__f__("log","at components/my-content-bar/my-content-bar.vue:278","所有药材数据加载完成")),i.index.__f__("log","at components/my-content-bar/my-content-bar.vue:280","加载数据量:",l.length),i.index.__f__("log","at components/my-content-bar/my-content-bar.vue:281","当前总数据:",this.allMedicines.length),e=Math.floor(this.allMedicines.length/r.nameData.length*100),this.loadingProgress=Math.min(e,100),await this.delay(100)}}catch(t){i.index.__f__("error","at components/my-content-bar/my-content-bar.vue:288","加载失败",t),i.index.showToast({title:"数据加载失败",icon:"none",duration:2e3})}finally{this.loadQueue--,this.isLoading=!1,setTimeout(()=>{this.showContentSkeleton=!1},500)}}},delay(t){return new Promise(s=>setTimeout(s,t))},getMedicineImage(t){return`/static/herb/${t}.jpg`},getLoadingProgress(){return Math.min(Math.floor(this.allMedicines.length/r.nameData.length*100),100)},async cachedRequest(t){if(u[t])return u[t];try{const s=await i.index.request({url:`http://api.zhyunxi.com/api.php?api=87&key=d51b5be2f98dd9bdf06e0bb47dea87fc&name=${encodeURIComponent(t)}`,timeout:1e4,dataType:"json"}),e=s[1]?s[1]:s;if(!e||e.statusCode!==200||!e.data||e.data.code!==0)return i.index.__f__("error","at components/my-content-bar/my-content-bar.vue:340",`[API异常] ${t}`,{status:e.statusCode,data:e.data||"无响应数据"}),null;const a=Array.isArray(e.data.data)&&e.data.data.length>0?e.data.data[0]:null;return a&&!(a.flavor||a.effect||a.property||a.function)?(i.index.__f__("warn","at components/my-content-bar/my-content-bar.vue:357",`[数据字段缺失] ${t}`,a),{flavor:"数据异常",effect:"数据异常",_rawData:a}):(u[t]=a,a)}catch(s){return i.index.__f__("error","at components/my-content-bar/my-content-bar.vue:368",`[网络异常] ${t}`,s.errMsg||s),null}}}};function M(t,s,e,a,o,h){return i.e({a:o.showContentSkeleton},o.showContentSkeleton?{b:i.f(2,(l,d,c)=>({a:i.f(5,(n,m,f)=>({a:n})),b:l})),c:i.t(o.loadingProgress),d:`${o.loadingProgress}%`}:{},{e:i.f(o.columnData,(l,d,c)=>({a:i.f(l,(n,m,f)=>({a:h.getMedicineImage(n.name),b:i.o(g=>h.updateItemHeight(g,n.id),n.id),c:i.t(n.name),d:i.t(n.flavor),e:i.t(n.effect),f:n.id,g:i.o(g=>h.goToContent(n.name),n.id),h:"box-"+n.id})),b:d})),f:o.isLoading},o.isLoading?{g:i.t(h.getLoadingProgress())}:{},{h:!o.hasMore},o.hasMore?{}:{})}const _=i._export_sfc(x,[["render",M]]);wx.createComponent(_);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/components/my-content-bar/my-content-bar.js.map
