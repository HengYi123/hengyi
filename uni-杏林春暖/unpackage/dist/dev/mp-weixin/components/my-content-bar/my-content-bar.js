"use strict";const i=require("../../common/vendor.js"),h=require("../../data/herbData.js"),u={},M={data(){return{columnCount:2,columnData:[[],[]],allMedicines:[],scrollViewHeight:600,scrollTop:0,itemHeight:360,visibleCount:0,startIndex:0,offsetTop:0,isLoading:!1,hasMore:!0,currentPage:1,pageSize:40,heightTimers:{},showContentSkeleton:!0,loadingProgress:0}},mounted(){this.loadMedicines(),this.initScrollView(),i.index.__f__("log","at components/my-content-bar/my-content-bar.vue:97","药材总数:",h.nameData.length)},computed:{totalHeight(){return this.allMedicines.length*this.itemHeight}},methods:{goToContent(t){i.index.navigateTo({url:`/pages/content/content?keyword=${t}&source=index`})},initScrollView(){this.$nextTick(()=>{i.index.createSelectorQuery().in(this).select(".virtual-scroll-container").boundingClientRect(n=>{n&&(this.scrollViewHeight=n.height,this.visibleCount=Math.max(1,Math.ceil(this.scrollViewHeight/this.itemHeight)+5))}).exec()})},calculateVisibleRange(t){if(Date.now()-this.lastScrollTime<100)return;const n=this.columnCount;Math.ceil(this.scrollViewHeight/this.itemHeight)*this.columnCount,this.startIndex=Math.max(0,Math.floor(t/this.itemHeight)*n-10),this.endIndex=this.allMedicines.length,typeof this.lastStartIndex>"u"&&(this.lastStartIndex=this.startIndex),Math.abs(this.startIndex-this.lastStartIndex)>30&&(this.updateVisibleItems(),this.lastStartIndex=this.startIndex),this.shouldLoadMore()&&this.loadMedicines(),this.offsetTop=this.startIndex*this.itemHeight},updateVisibleItems(){this.columnData.forEach(e=>e.length=0);const t=Math.min(this.endIndex,this.allMedicines.length),n=this.allMedicines.slice(this.startIndex,t);for(let e=0;e<this.columnCount;e++)Array.isArray(this.columnData[e])||(this.columnData[e]=[]),this.columnData[e].length=0;n.forEach((e,s)=>{const a=s%this.columnCount;this.columnData[a].push({...e,id:`item-${this.startIndex+s}`})})},updateItemHeight(t,n){clearTimeout(this.heightTimers[n]),this.heightTimers[n]=setTimeout(()=>{i.index.createSelectorQuery().in(this).select(`#box-${n}`).boundingClientRect(e=>{e&&e.height>this.itemHeight&&(this.itemHeight=e.height)}).exec()},200)},shouldLoadMore(){const t=this.allMedicines.length-this.endIndex;return!this.isLoading&&this.hasMore&&t>0},async loadMedicines(){if(this.showContentSkeleton=!0,this.loadingProgress=0,!(this.isLoading||!this.hasMore)){this.loadQueue++,this.isLoading=!0;try{const t=(this.currentPage-1)*this.pageSize;if(t>=h.nameData.length){this.hasMore=!1;return}const n=Math.ceil(h.nameData.length/this.pageSize);let e=0;for(let s=1;s<=n;s++){const a=Math.min(t+this.pageSize,h.nameData.length),c=h.nameData.slice(t,a),d=await Promise.all(c.map(async l=>{const o=await this.cachedRequest(l);return{id:`${this.currentPage}-${l}`,name:l,image:this.getMedicineImage(l),flavor:(o==null?void 0:o.flavor)||(o==null?void 0:o.property)||"暂无数据",effect:(o==null?void 0:o.effect)||(o==null?void 0:o.function)||"暂无数据"}}));this.allMedicines=[...this.allMedicines,...d],this.currentPage++,this.$nextTick(()=>{this.calculateVisibleRange(this.scrollTop),this.updateVisibleItems()}),this.loadingProgress=Math.min(Math.floor(this.allMedicines.length/h.nameData.length*100),100),this.allMedicines.length<h.nameData.length?this.$nextTick(()=>{this.loadMedicines()}):(this.hasMore=!1,i.index.__f__("log","at components/my-content-bar/my-content-bar.vue:274","所有药材数据加载完成")),i.index.__f__("log","at components/my-content-bar/my-content-bar.vue:276","加载数据量:",d.length),i.index.__f__("log","at components/my-content-bar/my-content-bar.vue:277","当前总数据:",this.allMedicines.length),e=Math.floor(this.allMedicines.length/h.nameData.length*100),this.loadingProgress=Math.min(e,100),await this.delay(100)}}catch(t){i.index.__f__("error","at components/my-content-bar/my-content-bar.vue:284","加载失败",t),i.index.showToast({title:"数据加载失败",icon:"none",duration:2e3})}finally{this.loadQueue--,this.isLoading=!1,setTimeout(()=>{this.showContentSkeleton=!1},500)}}},delay(t){return new Promise(n=>setTimeout(n,t))},getMedicineImage(t){return`/static/herb/${t}.jpg`},getLoadingProgress(){return Math.min(Math.floor(this.allMedicines.length/h.nameData.length*100),100)},async cachedRequest(t){if(u[t])return u[t];try{const n=await i.index.request({url:`http://api.zhyunxi.com/api.php?api=87&key=d51b5be2f98dd9bdf06e0bb47dea87fc&name=${encodeURIComponent(t)}`,timeout:1e4,dataType:"json"}),e=n[1]?n[1]:n;if(!e||e.statusCode!==200||!e.data||e.data.code!==0)return i.index.__f__("error","at components/my-content-bar/my-content-bar.vue:336",`[API异常] ${t}`,{status:e.statusCode,data:e.data||"无响应数据"}),null;const s=Array.isArray(e.data.data)&&e.data.data.length>0?e.data.data[0]:null;return s&&!(s.flavor||s.effect||s.property||s.function)?(i.index.__f__("warn","at components/my-content-bar/my-content-bar.vue:353",`[数据字段缺失] ${t}`,s),{flavor:"数据异常",effect:"数据异常",_rawData:s}):(u[t]=s,s)}catch(n){return i.index.__f__("error","at components/my-content-bar/my-content-bar.vue:364",`[网络异常] ${t}`,n.errMsg||n),null}}}};function x(t,n,e,s,a,c){return i.e({a:a.showContentSkeleton},a.showContentSkeleton?{b:i.f(2,(d,l,o)=>({a:i.f(5,(r,m,f)=>({a:r})),b:d})),c:i.t(a.loadingProgress),d:`${a.loadingProgress}%`}:{},{e:i.f(a.columnData,(d,l,o)=>({a:i.f(d,(r,m,f)=>({a:c.getMedicineImage(r.name),b:i.o(g=>c.updateItemHeight(g,r.id),r.id),c:i.t(r.name),d:i.t(r.flavor),e:i.t(r.effect),f:r.id,g:i.o(g=>c.goToContent(r.name),r.id),h:"box-"+r.id})),b:l})),f:a.isLoading},a.isLoading?{g:i.t(c.getLoadingProgress())}:{},{h:!a.hasMore},a.hasMore?{}:{})}const _=i._export_sfc(M,[["render",x]]);wx.createComponent(_);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/components/my-content-bar/my-content-bar.js.map
