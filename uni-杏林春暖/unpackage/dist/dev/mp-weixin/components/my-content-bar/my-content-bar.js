"use strict";const e=require("../../common/vendor.js"),i=require("../../data/herbData.js"),d={},g={data(){return{columnCount:2,columnData:[[],[]],allMedicines:[],isLoading:!1,hasMore:!0,currentPage:1,pageSize:20,showContentSkeleton:!0,loadingProgress:0,loadedIds:new Set}},mounted(){this.loadMedicines(),e.index.__f__("log","at components/my-content-bar/my-content-bar.vue:88","药材总数:",i.nameData.length),e.index.$on("scrollToBottom",this.handleScrollToBottom)},beforeDestroy(){e.index.$off("scrollToBottom",this.handleScrollToBottom)},methods:{handleScrollToBottom(){!this.isLoading&&this.hasMore&&this.loadMedicines()},goToContent(o){e.index.navigateTo({url:`/pages/content/content?keyword=${o}&source=index`})},async loadMedicines(){if(!(this.isLoading||!this.hasMore)){this.isLoading=!0,this.showContentSkeleton=!0;try{const a=(await Promise.all(i.nameData.map(async t=>{if(this.loadedIds.has(t))return null;const n=await this.cachedRequest(t);return this.loadedIds.add(t),{id:t,name:t,image:this.getMedicineImage(t),flavor:(n==null?void 0:n.flavor)||(n==null?void 0:n.property)||"暂无数据",effect:(n==null?void 0:n.effect)||(n==null?void 0:n.function)||"暂无数据"}}))).filter(t=>t!==null&&t.name);this.allMedicines=[...this.allMedicines,...a],this.updateVisibleItems(),this.loadingProgress=Math.min(Math.floor(this.loadedIds.size/i.nameData.length*100),100),e.index.__f__("log","at components/my-content-bar/my-content-bar.vue:155","加载数据量:",a.length),e.index.__f__("log","at components/my-content-bar/my-content-bar.vue:156","当前总数据:",this.allMedicines.length),this.loadedIds.size>=i.nameData.length&&(this.hasMore=!1,e.index.__f__("log","at components/my-content-bar/my-content-bar.vue:161","所有药材数据加载完成"))}catch(o){e.index.__f__("error","at components/my-content-bar/my-content-bar.vue:164","加载失败",o),e.index.showToast({title:"数据加载失败",icon:"none",duration:2e3})}finally{this.isLoading=!1,setTimeout(()=>{this.showContentSkeleton=!1},500)}}},updateVisibleItems(){this.columnData=Array.from({length:this.columnCount},()=>[]);const o=Array(this.columnCount).fill(0);this.allMedicines.forEach(a=>{const t=o.indexOf(Math.min(...o));this.columnData[t].push(a),o[t]+=420}),this.$forceUpdate()},getMedicineImage(o){return`/static/herb/${o}.jpg`},getLoadingProgress(){return Math.min(Math.floor(this.allMedicines.length/i.nameData.length*100),100)},async cachedRequest(o){if(d[o])return d[o];try{const a=await e.index.request({url:`http://api.zhyunxi.com/api.php?api=87&key=d51b5be2f98dd9bdf06e0bb47dea87fc&name=${encodeURIComponent(o)}`,timeout:1e4,dataType:"json"}),t=a[1]?a[1]:a;if(!t||t.statusCode!==200||!t.data||t.data.code!==0)return e.index.__f__("error","at components/my-content-bar/my-content-bar.vue:232",`[API异常] ${o}`,{status:t.statusCode,data:t.data||"无响应数据"}),null;const n=Array.isArray(t.data.data)&&t.data.data.length>0?t.data.data[0]:null;return n&&!(n.flavor||n.effect||n.property||n.function)?(e.index.__f__("warn","at components/my-content-bar/my-content-bar.vue:249",`[数据字段缺失] ${o}`,n),{flavor:"数据异常",effect:"数据异常",_rawData:n}):(d[o]=n,n)}catch(a){return e.index.__f__("error","at components/my-content-bar/my-content-bar.vue:260",`[网络异常] ${o}`,a.errMsg||a),null}}}};function _(o,a,t,n,s,c){return e.e({a:s.showContentSkeleton},s.showContentSkeleton?{b:e.f(2,(l,h,u)=>({a:e.f(5,(r,f,m)=>({a:r})),b:l})),c:e.t(s.loadingProgress),d:`${s.loadingProgress}%`}:{},{e:e.f(s.columnData,(l,h,u)=>({a:e.f(l,(r,f,m)=>({a:c.getMedicineImage(r.name),b:e.t(r.name),c:e.t(r.flavor),d:e.t(r.effect),e:r.id,f:e.o(b=>c.goToContent(r.name),r.id)})),b:h})),f:s.isLoading},s.isLoading?{g:e.t(c.getLoadingProgress())}:{},{h:!s.hasMore},s.hasMore?{}:{})}const y=e._export_sfc(g,[["render",_]]);wx.createComponent(y);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/components/my-content-bar/my-content-bar.js.map
