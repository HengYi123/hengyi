"use strict";const e=require("../../common/vendor.js"),c=require("../../common/assets.js"),d={data(){return{latitude:39.90923,longitude:116.397428,currentAddress:"",markers:[{id:1,latitude:39.90923,longitude:116.397428,iconPath:"/static/map/pin.png",width:30,height:40,callout:{content:"当前位置",color:"#fff",bgColor:"#1A73E8",padding:8,borderRadius:4,display:"ALWAYS"}}],controls:[{id:1,position:{left:10,top:100,width:40,height:40},iconPath:"/static/map/定位.png",clickable:!0}],sourcePage:"",searchInput:"",searchResults:[],mapContext:null,hasLocationPermission:!1}},onLoad(t){this.sourcePage=t.sourcePage||"",this.checkLocationPermission()},onReady(){this.mapContext=e.index.createMapContext("myMap",this)},methods:{onControlTap(t){t.controlId===1&&this.startLocation()},openSearchPopup(){this.$refs.searchPopup.open()},onSearchConfirm(t){if(this.searchInput=t,this.$refs.searchPopup.close(),!this.searchInput.trim()){e.index.showToast({title:"请输入搜索关键词",icon:"none"});return}this.performSearch(this.searchInput)},async performSearch(t){e.index.showLoading({title:"搜索中...",mask:!0});try{const s=await e.index.request({url:"https://apis.map.qq.com/ws/place/v1/search",data:{key:"OMEBZ-JYNEW-BX6RJ-Y63WC-JS4BE-4SB6C",keyword:t,boundary:"region(北京,0)",page_size:20}});e.index.hideLoading(),s.data.status===0?(this.searchResults=s.data.data||[],this.searchResults.length===0&&e.index.showToast({title:"未找到相关地点",icon:"none"})):(e.index.showToast({title:`搜索失败: ${s.data.message}`,icon:"none"}),e.index.__f__("error","at pages/map/map.vue:170","腾讯地图搜索API错误:",s.data))}catch(s){e.index.hideLoading(),e.index.showToast({title:"搜索请求异常",icon:"none"}),e.index.__f__("error","at pages/map/map.vue:175","搜索请求异常:",s)}},selectSearchResult(t){this.latitude=t.location.lat,this.longitude=t.location.lng,this.markers[0]={...this.markers[0],latitude:t.location.lat,longitude:t.location.lng,callout:{...this.markers[0].callout,content:t.title}},this.mapContext.moveToLocation({latitude:t.location.lat,longitude:t.location.lng});const s=`${t.title}（${t.address}）`;this.currentAddress=s,e.index.setStorageSync("selectedAddress",s),this.returnSelectedAddress(s,t.location.lat,t.location.lng),this.clearSearchResults()},returnSelectedAddress(t,s,a){const r=getCurrentPages(),o=r[r.length-2];o&&o.route==="pages/my/my"?(o.$vm&&o.$vm.updateAddress&&o.$vm.updateAddress(t),e.index.$emit("updateUserAddress",t),setTimeout(()=>{e.index.navigateBack({delta:1,success:()=>{e.index.showToast({title:"地址选择成功",icon:"success"})}})},500)):e.index.showModal({title:"地址已选择",content:`已选择地址：${t}`,confirmText:"确定",showCancel:!1})},clearSearchResults(){this.searchResults=[]},checkLocationPermission(){e.index.getSetting({success:t=>{t.authSetting["scope.userLocation"]?(this.hasLocationPermission=!0,this.doLocation()):(this.hasLocationPermission=!1,this.currentAddress="请点击定位按钮获取位置")},fail:()=>{this.hasLocationPermission=!1,this.currentAddress="权限检查失败"}})},checkLocationPermission(){e.index.getSetting({success:t=>{t.authSetting["scope.userLocation"]?this.doLocation():this.currentAddress="请点击定位按钮获取位置"}})},startLocation(){if(this.hasLocationPermission){this.doLocation();return}e.index.authorize({scope:"scope.userLocation",success:()=>{this.hasLocationPermission=!0,this.doLocation()},fail:t=>{t.errMsg.indexOf("deny")!==-1?e.index.showModal({title:"权限提示",content:"需要位置权限才能获取当前位置，请前往设置开启权限",confirmText:"去设置",success:s=>{s.confirm&&e.index.openSetting({success:a=>{a.authSetting["scope.userLocation"]&&(this.hasLocationPermission=!0,this.doLocation())}})}}):e.index.showToast({title:"权限请求失败",icon:"none"})}})},doLocation(){if(!this.hasLocationPermission){this.startLocation();return}e.index.showLoading({title:"定位中...",mask:!0}),e.index.getLocation({type:"gcj02",altitude:!0,success:t=>{this.latitude=t.latitude,this.longitude=t.longitude,this.markers=[{...this.markers[0],latitude:t.latitude,longitude:t.longitude}],this.reverseGeocode(t.latitude,t.longitude),this.mapContext.moveToLocation({latitude:t.latitude,longitude:t.longitude,success:()=>{e.index.hideLoading()}})},fail:t=>{e.index.hideLoading();let s="定位失败";t.errMsg.indexOf("auth")!==-1?(s="定位权限未开启",this.hasLocationPermission=!1):t.errMsg.indexOf("available")!==-1&&(s="定位服务不可用"),e.index.showToast({title:s,icon:"none",duration:3e3})}})},async reverseGeocode(t,s){try{const a=await e.index.request({url:"https://apis.map.qq.com/ws/geocoder/v1/",data:{key:"OMEBZ-JYNEW-BX6RJ-Y63WC-JS4BE-4SB6C",location:`${t},${s}`}});a&&a.data&&a.data.status===0?this.currentAddress=a.data.result.address||"地址解析成功但无详细地址":(this.currentAddress="地址解析失败",e.index.__f__("error","at pages/map/map.vue:420","腾讯地图逆地理编码失败:",a?a.data:error))}catch(a){this.currentAddress="地址解析失败",e.index.__f__("error","at pages/map/map.vue:424","逆地理编码请求异常:",a)}},onControlTap(t){t.controlId===1&&e.index.navigateTo({url:"/pages/map/search"})},goBack(){this.sourcePage==="cart"?e.index.navigateBack({delta:1}):e.index.redirectTo({url:"/pages/index/index"})}}};if(!Array){const t=e.resolveComponent("uni-popup-dialog"),s=e.resolveComponent("uni-popup");(t+s)()}const l=()=>"../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js",h=()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||(l+h)();function p(t,s,a,r,o,n){return e.e({a:c._imports_0$2,b:e.o((...i)=>n.goBack&&n.goBack(...i)),c:o.latitude,d:o.longitude,e:o.markers,f:o.controls,g:e.o((...i)=>n.onControlTap&&n.onControlTap(...i)),h:c._imports_1$3,i:e.o((...i)=>n.startLocation&&n.startLocation(...i)),j:c._imports_2$2,k:e.t(o.currentAddress||"点击搜索或定位..."),l:e.o((...i)=>n.openSearchPopup&&n.openSearchPopup(...i)),m:e.o(n.onSearchConfirm),n:e.p({mode:"input",title:"搜索地点",value:o.searchInput,placeholder:"请输入地址或地名"}),o:e.sr("searchPopup","68d23675-0"),p:e.p({type:"dialog"}),q:o.searchResults.length>0},o.searchResults.length>0?{r:e.f(o.searchResults,(i,u,m)=>({a:e.t(i.title),b:e.t(i.address),c:u,d:e.o(f=>n.selectSearchResult(i),u)})),s:e.o((...i)=>n.clearSearchResults&&n.clearSearchResults(...i))}:{})}const g=e._export_sfc(d,[["render",p]]);wx.createPage(g);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/map/map.js.map
